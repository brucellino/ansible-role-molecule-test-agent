pipeline {
  options {
    checkoutToSubdirectory('ansible-role-molecule-test-agent')
  }
  agent none
  environment {
    AWS_REGION='eu-central-1'
    QUAY_PASSWORD="uefadevops+quaybot"
  }
  stages {
    stage('Test') {
      agent { label 'molecule-ecs' }
      when {
        changeRequest()
        beforeAgent true
      }
      steps {
        checkout scm
        sh 'ls -la'
        sh 'pwd'
        echo 'Lint stage'
        sh '''
. /opt/virtualenv/molecule3/bin/activate
molecule lint
molecule converge
molecule verify
          '''
      } // steps
      post {
        always {
          junit 'molecule/**/*.xml'
          sh '''
. /opt/virtualenv/molecule3/bin/activate
molecule destroy
          '''
        }
      }
    }
    stage('Bake') {
      when {
        branch 'master'
        beforeAgent true
      }
      agent { label 'molecule-ecs' }
      steps {
        checkout scm
        dir('.pipeline') {
          withCredentials([
          usernamePassword(
            credentialsId: 'uefadevops+quaybot/',
            usernameVariable: 'QUAY_USERNAME',
            passwordVariable: 'QUAY_PASSWORD' )
          ]) {
            sh '''
.  /opt/virtualenv/molecule3/bin/activate
packer build
docker login -u="${QUAY_USERNAME}" -p="${QUAY_PASSWORD}" quay.io
docker push quay.io/uefadevops/molecule-build-agent
docker logout
              '''
          } // credentials
        } // dir
      } // steps
    } // bake stage
  } // stages
} // pipeline
