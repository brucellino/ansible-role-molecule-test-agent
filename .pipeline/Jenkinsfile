pipeline {
  options {
    checkoutToSubdirectory('ansible-role-molecule-test-agent')
  }
  agent none
  environment {
    AWS_REGION='eu-central-1'
  }
  stages {
    stage('Test') {
      when {
        changeRequest()
        beforeAgent true
      }
      parallel {
        stage('EC2') {
          agent { label 'molecule-ecs' }
          steps {
            checkout scm
            sh 'ls -la'
            sh 'pwd'
            echo 'Lint stage'
            withCredentials([[
              $class: 'AmazonWebServicesCredentialsBinding',
              accessKeyVariable: 'AWS_ACCESS_KEY_ID',
              credentialsId: 'aws_sandbox_credentials_jenkins',
              secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
            sh '''
  . /opt/virtualenv/molecule3/bin/activate
  molecule lint -s ec2
  molecule converge -s ec2
  molecule verify -s ec2
            '''
          } // credentials
        } // steps
        post {
          always {
            junit 'molecule/ec2/*.xml'
            sh '''
  . /opt/virtualenv/molecule3/bin/activate
  molecule -s ec2 destroy
            '''
          } // always post
        } // post
      } // stage
      stage('Docker') {
        agent { label 'molecule-ecs' }
        steps {
          checkout scm
          sh '''
. /opt/virtualenv/molecule/bin/activate
molecule -s ec2 lint
          '''
          } // steps
          post {
            always {
              sh '''
. /opt/virtualenv/molecule3/bin/activate
molecule -s ec2 destroy
                '''
            } // always post
          } // post
        } // stage
      } // parallel test stage
    } // Test stage
    stage('Bake') {
      when {
        branch 'master'
        beforeAgent true
      }
      agent { label 'ec2-bionic' }
      steps {
        checkout scm
        dir('.pipeline') {
          withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws_infra_credential',
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'],
          usernamePassword(
            credentialsId: 'uefadevops+quaybot',
            usernameVariable: 'QUAY_USERNAME',
            passwordVariable: 'QUAY_PASSWORD' )]) {
            sh '''
packer build packer.json
docker login -u="${QUAY_USERNAME}" -p="${QUAY_PASSWORD}" quay.io
docker push quay.io/uefadevops/molecule-build-agent
docker logout
              '''
          } // credentials
        } // dir
      } // steps
    } // bake stage
  } // stages
} // pipeline
